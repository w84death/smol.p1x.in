
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>smol ASM Viewer - Static Page</title>
        <style>
            
        @font-face {
            font-family: 'DepartureMono';
            src: url('DepartureMono-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'DepartureMono', cursive;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #0a0a0a;
            color: #00ff00;
            text-shadow: 0 0 5px #cccccc;
            font-size: 14px;
            line-height: 1.5;
        }
        a {
            color:#00ff00;
        }
        a:hover {
            color:white;
        }
        h1, h2 {
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff;
        }
        h1 { font-size: 24px; }
        h2 { font-size: 20px; }
        h3 { font-size: 18px; color: #ff00ff; text-shadow: 0 0 10px #ff00ff; }
        #fileInput, #saveButton {
            margin-bottom: 20px;
            background-color: #1a1a1a;
            color: #00ffff;
            border: 1px solid #00ffff;
            padding: 5px;
            font-family: 'DepartureMono', cursive;
        }
        #saveButton {
            cursor: pointer;
            margin-left: 10px;
        }
        #headerDescription {
            color: #ffff00;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
        .asmSection {
            margin-bottom: 30px;
        }
        .asmView {
            white-space: pre-wrap;
            display: flex;
        }
        .code-column {
            flex: 1;
            color: #00ffff;
            padding-right: 20px;
        }
        .comment-column {
            flex: 1;
            color: #ff00ff;
        }
        .line-number {
            color: #ffff00;
            margin-right: 10px;
        }
        .sectionDescription {
            color: #ffff00;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
    
        </style>
    </head>
    <body>
        <div id="headerDescription">
                        <h1>GAME10 - Mysteries of the Forgotten Isles</h1>
                        <h2>game10.asm</h2>
                        <pre>Logic 2D game in VGA graphics, w PC Speaker sound.
Size category: 4096 bytes / 4KB
Bootloader: 512 bytes
Author: Krzysztof Krystian Jankowski
Web: smol.p1x.in/assembly/forgotten-isles/
License: MIT</pre>
                    </div>
        <div id="asmContent">
                                        <div class="asmSection">
                                            <h3>MEMORY ADDRESSES</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">   1</span>org 0x100
<span class="line-number">   2</span>use16
<span class="line-number">   3</span>
<span class="line-number">   4</span>jmp start
<span class="line-number">   5</span>
<span class="line-number">   6</span>include 'tunes.asm'
<span class="line-number">   7</span>include 'brushes.asm'
<span class="line-number">   8</span>include 'tiles.asm'
<span class="line-number">   9</span>include 'levels.asm'
<span class="line-number">  10</span>include 'vectors.asm'
<span class="line-number">  11</span>include 'palettes.asm'
<span class="line-number">  12</span>
<span class="line-number">  13</span>
<span class="line-number">  14</span>BEEP_BITE equ 3
<span class="line-number">  15</span>BEEP_PICK equ 15
<span class="line-number">  16</span>BEEP_PUT equ 20
<span class="line-number">  17</span>BEEP_GOLD equ 5
<span class="line-number">  18</span>BEEP_STEP equ 25
<span class="line-number">  19</span>BEEP_WEB equ 30
<span class="line-number">  20</span>
<span class="line-number">  22</span>
<span class="line-number">  23</span>_BASE_ equ 0x2000
<span class="line-number">  24</span>_PLAYER_ENTITY_ID_ equ _BASE_ 
<span class="line-number">  25</span>_REQUEST_POSITION_ equ _BASE_ + 0x02 
<span class="line-number">  26</span>_HOLDING_ID_ equ _BASE_ + 0x04       
<span class="line-number">  27</span>_SCORE_ equ _BASE_ + 0x05            
<span class="line-number">  28</span>_SCORE_TARGET_ equ _BASE_ + 0x06     
<span class="line-number">  29</span>_GAME_TICK_ equ _BASE_ + 0x07        
<span class="line-number">  30</span>_GAME_STATE_ equ _BASE_ + 0x09       
<span class="line-number">  31</span>_WEB_LOCKED_ equ _BASE_ + 0x0a       
<span class="line-number">  32</span>_LAST_TICK_ equ _BASE_ + 0x0b        
<span class="line-number">  33</span>_CURRENT_TUNE_ equ _BASE_ + 0x0d     
<span class="line-number">  34</span>_NEXT_TUNE_ equ _BASE_ + 0x0f        
<span class="line-number">  35</span>_NOTE_TIMER_ equ _BASE_ + 0x11       
<span class="line-number">  36</span>_NOTE_TEMPO_ equ _BASE_ + 0x12       
<span class="line-number">  37</span>_VECTOR_COLOR_ equ _BASE_ + 0x13     
<span class="line-number">  38</span>_LIFE_ equ _BASE_ + 0x15             
<span class="line-number">  39</span>_LIFE_TARGET_ equ _BASE_ + 0x16      
<span class="line-number">  40</span>_CURRENT_LEVEL_ equ _BASE_ + 0x17    
<span class="line-number">  41</span>_MAX_ENTITIES_  equ _BASE_ + 0x18    
<span class="line-number">  42</span>_ENTITIES_ equ _BASE_ + 0x40         
<span class="line-number">  43</span>
<span class="line-number">  44</span>_BG_BUFFER_MEMORY_ equ 0x3000 
<span class="line-number">  45</span>_DBUFFER_MEMORY_ equ 0x4000   
<span class="line-number">  46</span>_VGA_MEMORY_ equ 0xA000       
<span class="line-number">  47</span>_TICK_ equ 1Ah                
<span class="line-number">  48</span>
<span class="line-number">  49</span>_ID_ equ 0      
<span class="line-number">  50</span>_POS_ equ 1     
<span class="line-number">  51</span>_POS_OLD_ equ 3 
<span class="line-number">  52</span>_SCREEN_POS_ equ 5
<span class="line-number">  53</span>_MIRROR_ equ 7  
<span class="line-number">  54</span>_STATE_ equ 8   
<span class="line-number">  55</span>_DIR_ equ 9     
<span class="line-number">  56</span>_ANIM_ equ 10    
<span class="line-number">  57</span>
</div>
                                                <div class="comment-column">





















; 2 bytes
; 2 bytes
; 1 byte
; 1 byte
; 1 byte
; 2 bytes
; 1 byte
; 1 byte
; 2 bytes
; 2 bytes
; 2 bytes
; 1 byte
; 1 byte
; 2 bytes
; 1 byte
; 1 byte
; 1 byte
; 1 byte
; 11 bytes per entity, 64 entites cap, 320 bytes

; 64k bytes
; 64k bytes
; 64k bytes
; BIOS tick

; 1 byte
; 2 bytes
; 2 bytes
; 2 bytes
; 1 byte
; 1 bytes
; 1 byte
; 1 byte ; 11 bytes total

</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>MAGIC NUMBERS</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">  59</span>
<span class="line-number">  60</span>ENTITY_SIZE  equ 11
<span class="line-number">  61</span>ENTITIES_SPEED equ 2
<span class="line-number">  62</span>AVAILABLE_LEVELS equ 0x3
<span class="line-number">  63</span>LEVEL_START_POSITION equ 320*68+32
<span class="line-number">  64</span>COLOR_SKY equ 0x3c3c
<span class="line-number">  65</span>COLOR_WATER equ 0x3434
<span class="line-number">  66</span>SCORE_POSITION equ 320*24+32
<span class="line-number">  67</span>INTRO_TIME equ 240
<span class="line-number">  68</span>PRE_GAME_TIME equ 64
<span class="line-number">  69</span>POST_GAME_TIME equ 32
<span class="line-number">  70</span>WEB_LOCK equ 2
<span class="line-number">  71</span>COLOR_TRANSPARENT equ 0x0F
<span class="line-number">  72</span>
<span class="line-number">  73</span>ID_PLAYER equ 0
<span class="line-number">  74</span>ID_PALM equ 1
<span class="line-number">  75</span>ID_SNAKE equ 2
<span class="line-number">  76</span>ID_ROCK equ 3
<span class="line-number">  77</span>ID_SKULL equ 4
<span class="line-number">  78</span>ID_BRIDGE equ 5
<span class="line-number">  79</span>ID_CHEST equ 6
<span class="line-number">  80</span>ID_GOLD equ 7
<span class="line-number">  81</span>ID_SPIDER equ 10
<span class="line-number">  82</span>ID_CRAB equ 11
<span class="line-number">  83</span>ID_BUSH equ 12
<span class="line-number">  84</span>
<span class="line-number">  85</span>STATE_DEACTIVATED equ 0
<span class="line-number">  86</span>STATE_FOLLOW equ 2
<span class="line-number">  87</span>STATE_STATIC equ 4
<span class="line-number">  88</span>STATE_EXPLORING equ 8
<span class="line-number">  89</span>STATE_INTERACTIVE equ 16
<span class="line-number">  90</span>
<span class="line-number">  91</span>GSTATE_INTRO equ 2
<span class="line-number">  92</span>GSTATE_PREGAME equ 4
<span class="line-number">  93</span>GSTATE_GAME equ 8
<span class="line-number">  94</span>GSTATE_POSTGAME equ 16
<span class="line-number">  95</span>GSTATE_END equ 32
<span class="line-number">  96</span>GSTATE_WIN equ 64
<span class="line-number">  97</span>GSTATE_NEXT equ 128
<span class="line-number">  98</span>GSTATE_OUTRO equ 256
<span class="line-number">  99</span>
<span class="line-number"> 100</span>start:
<span class="line-number"> 101</span>
</div>
                                                <div class="comment-column">










































</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>INITIALIZATION</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 103</span>
<span class="line-number"> 104</span>    mov ax, 0x13         
<span class="line-number"> 105</span>    int 0x10             
<span class="line-number"> 106</span>
<span class="line-number"> 107</span>    mov ax, cs           
<span class="line-number"> 108</span>    mov ss, ax
<span class="line-number"> 109</span>    mov sp, 0xFFFE       
<span class="line-number"> 110</span>
<span class="line-number"> 111</span>  set_keyboard_rate:
<span class="line-number"> 112</span>    xor ax, ax
<span class="line-number"> 113</span>    xor bx, bx
<span class="line-number"> 114</span>    mov ah, 03h         
<span class="line-number"> 115</span>    mov bl, 1Fh         
<span class="line-number"> 116</span>    int 16h             
<span class="line-number"> 117</span>
<span class="line-number"> 118</span>restart_game:
<span class="line-number"> 119</span>  mov byte [_GAME_STATE_], GSTATE_INTRO
<span class="line-number"> 120</span>  mov byte [_CURRENT_LEVEL_], 0x0
<span class="line-number"> 121</span>  mov byte [_SCORE_], 0x0
<span class="line-number"> 122</span>  mov byte [_LIFE_], 0x3
<span class="line-number"> 123</span>  mov byte [_LIFE_TARGET_], 0x3
<span class="line-number"> 124</span>  mov word [_GAME_TICK_], 0x0
<span class="line-number"> 125</span>  mov byte [_HOLDING_ID_], 0x0
<span class="line-number"> 126</span>  mov byte [_WEB_LOCKED_], 0x0
<span class="line-number"> 127</span>  mov word [_CURRENT_TUNE_], tune_intro
<span class="line-number"> 128</span>  mov word [_NEXT_TUNE_], tune_intro           
<span class="line-number"> 129</span>  mov byte [_NOTE_TIMER_], 0x0
<span class="line-number"> 130</span>
<span class="line-number"> 131</span>
<span class="line-number"> 132</span>call spawn_entities
<span class="line-number"> 133</span>
</div>
                                                <div class="comment-column">
; Init VGA 320x200x256
; Video BIOS interrupt

; All segments point to the same memory in .COM

; Stack grows downward from near the top of memory




; BIOS function to set typematic rate and delay
; BL = 31 (0x1F) for maximum repeat rate (30 Hz) and 0 delay
; Call BIOS











; loop intro tune





</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>DRAW BACKGROUND</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 135</span>
<span class="line-number"> 136</span>push _BG_BUFFER_MEMORY_
<span class="line-number"> 137</span>pop es                                  
<span class="line-number"> 138</span>xor di,di
<span class="line-number"> 139</span>xor si,si
<span class="line-number"> 140</span>
<span class="line-number"> 141</span>draw_bg:
<span class="line-number"> 142</span>  mov ax, COLOR_SKY               
<span class="line-number"> 143</span>  mov dl, 0xf                  
<span class="line-number"> 144</span>  .draw_sky:
<span class="line-number"> 145</span>    mov cx, 320*2           
<span class="line-number"> 146</span>    rep stosw               
<span class="line-number"> 147</span>    inc ax                  
<span class="line-number"> 148</span>    xchg al, ah             
<span class="line-number"> 149</span>    dec dl
<span class="line-number"> 150</span>    jnz .draw_sky
<span class="line-number"> 151</span>
<span class="line-number"> 152</span>  .draw_ocean:
<span class="line-number"> 153</span>    mov ax, COLOR_WATER               
<span class="line-number"> 154</span>    mov dl, 0x4                  
<span class="line-number"> 155</span>    .line:
<span class="line-number"> 156</span>      mov cx, 320*16          
<span class="line-number"> 157</span>      rep stosw               
<span class="line-number"> 158</span>      dec al                  
<span class="line-number"> 159</span>      xchg al, ah             
<span class="line-number"> 160</span>      dec dl
<span class="line-number"> 161</span>      jnz .line
<span class="line-number"> 162</span>
<span class="line-number"> 163</span>    mov cx, 320*6
<span class="line-number"> 164</span>    rep stosw
<span class="line-number"> 165</span>
<span class="line-number"> 166</span>    
</div>
                                                <div class="comment-column">

; as target




; Set starting sky color
; 10 bars to draw

; 3 pixels high
; Write to the doublebuffer
; Increment color index for next bar
; Swap colors




; Set starting sky color
; 10 bars to draw

; 3 pixels high
; Write to the doublebuffer
; Increment color index for next bar
; Swap colors







</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>GAME LOGIC</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 168</span>
<span class="line-number"> 169</span>game_loop:
<span class="line-number"> 170</span>  push ds
<span class="line-number"> 171</span>
<span class="line-number"> 172</span>  push _BG_BUFFER_MEMORY_
<span class="line-number"> 173</span>  pop ds
<span class="line-number"> 174</span>  xor si, si
<span class="line-number"> 175</span>
<span class="line-number"> 176</span>  push _DBUFFER_MEMORY_
<span class="line-number"> 177</span>  pop es               
<span class="line-number"> 178</span>  xor di, di
<span class="line-number"> 179</span>
<span class="line-number"> 180</span>  mov cx, 0x7D00
<span class="line-number"> 181</span>  rep movsw
<span class="line-number"> 182</span>
<span class="line-number"> 183</span>  pop ds
<span class="line-number"> 184</span>
<span class="line-number"> 185</span>
</div>
                                                <div class="comment-column">

















</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>INTRO</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 187</span>
<span class="line-number"> 188</span>test byte [_GAME_STATE_], GSTATE_INTRO
<span class="line-number"> 189</span>jz skip_game_state_intro
<span class="line-number"> 190</span>
<span class="line-number"> 191</span>  call play_tune
<span class="line-number"> 192</span>  call draw_clouds
<span class="line-number"> 193</span>
<span class="line-number"> 194</span>  
<span class="line-number"> 195</span>  mov ah, [_GAME_TICK_]  
<span class="line-number"> 196</span>  and ah, 0xf
<span class="line-number"> 197</span>  add ah, 0x6c
<span class="line-number"> 198</span>  mov al, 0x87
<span class="line-number"> 199</span>  mov word [_VECTOR_COLOR_], ax
<span class="line-number"> 200</span>
<span class="line-number"> 201</span>  mov ax, [_GAME_TICK_]
<span class="line-number"> 202</span>  cmp ax, 0xf
<span class="line-number"> 203</span>  jl .skip_logo_draw
<span class="line-number"> 204</span>  mov bp, 320*65+80
<span class="line-number"> 205</span>  mov si, LogoVector
<span class="line-number"> 206</span>  call draw_vector
<span class="line-number"> 207</span>  .skip_logo_draw:
<span class="line-number"> 208</span>
<span class="line-number"> 209</span>  cmp ax, 0x1f
<span class="line-number"> 210</span>  jl .skip_logo2_draw
<span class="line-number"> 211</span>  mov si, Logo2Vector
<span class="line-number"> 212</span>  call draw_vector
<span class="line-number"> 213</span>  .skip_logo2_draw:
<span class="line-number"> 214</span>
<span class="line-number"> 215</span>  mov word [_VECTOR_COLOR_], 0x0687
<span class="line-number"> 216</span>  mov si, PalmVector
<span class="line-number"> 217</span>  mov bp, 320*55-18
<span class="line-number"> 218</span>  call draw_vector
<span class="line-number"> 219</span>  
<span class="line-number"> 220</span>  mov word [_VECTOR_COLOR_], 0x7876
<span class="line-number"> 221</span>  mov si, PalmGreenVector
<span class="line-number"> 222</span>  call draw_vector
<span class="line-number"> 223</span>
<span class="line-number"> 224</span>  add bp, 320*95-32
<span class="line-number"> 225</span>  call draw_vector
<span class="line-number"> 226</span>
<span class="line-number"> 227</span>  add bp, 290
<span class="line-number"> 228</span>  call draw_vector
<span class="line-number"> 229</span>
<span class="line-number"> 230</span>  sub bp, 320*20+20
<span class="line-number"> 231</span>  call draw_vector
<span class="line-number"> 232</span>  
<span class="line-number"> 233</span>  sub bp, 320*170-20
<span class="line-number"> 234</span>  call draw_vector
<span class="line-number"> 235</span>
<span class="line-number"> 236</span>  mov word [_VECTOR_COLOR_], 0x1e14
<span class="line-number"> 237</span>  mov si, P1XVector
<span class="line-number"> 238</span>  mov bp, 320*150+270
<span class="line-number"> 239</span>  call draw_vector
<span class="line-number"> 240</span>
<span class="line-number"> 241</span>  mov ah, 01h         
<span class="line-number"> 242</span>  int 16h             
<span class="line-number"> 243</span>  jz .no_key_press
<span class="line-number"> 244</span>  .start_game:
<span class="line-number"> 245</span>
<span class="line-number"> 246</span>  mov byte [_GAME_STATE_], GSTATE_PREGAME
<span class="line-number"> 247</span>  add byte [_GAME_STATE_], GSTATE_GAME
<span class="line-number"> 248</span>  mov word [_GAME_TICK_], 0x0
<span class="line-number"> 249</span>  call draw_level
<span class="line-number"> 250</span>  .no_key_press:
<span class="line-number"> 251</span>
<span class="line-number"> 252</span>skip_game_state_intro:
<span class="line-number"> 253</span>
</div>
                                                <div class="comment-column">





















































; BIOS keyboard status function
; Call BIOS interrupt











</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>PRE-GAME</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 255</span>
<span class="line-number"> 256</span>test byte [_GAME_STATE_], GSTATE_PREGAME
<span class="line-number"> 257</span>jz skip_game_state_pregame
<span class="line-number"> 258</span>
<span class="line-number"> 259</span>pre_game:
<span class="line-number"> 260</span>    mov di, 320*52
<span class="line-number"> 261</span>    mov ax, [_GAME_TICK_]
<span class="line-number"> 262</span>    cmp ax, PRE_GAME_TIME
<span class="line-number"> 263</span>    jg .start_game
<span class="line-number"> 264</span>    shr ax, 1
<span class="line-number"> 265</span>    add di, ax
<span class="line-number"> 266</span>    mov bx, 0x1
<span class="line-number"> 267</span>    call draw_ship
<span class="line-number"> 268</span>    call play_tune
<span class="line-number"> 269</span>    jmp skip_game_state_pregame
<span class="line-number"> 270</span>
<span class="line-number"> 271</span>  .start_game:
<span class="line-number"> 272</span>    mov byte [_GAME_STATE_], GSTATE_GAME
<span class="line-number"> 273</span>    mov word [_GAME_TICK_], 0x0
<span class="line-number"> 274</span>
<span class="line-number"> 275</span>  .clear_kb_buffer:
<span class="line-number"> 276</span>    mov ah, 0x01
<span class="line-number"> 277</span>    int 0x16
<span class="line-number"> 278</span>    jz .cleared
<span class="line-number"> 279</span>      mov ah, 0x00
<span class="line-number"> 280</span>      int 0x16
<span class="line-number"> 281</span>      jmp .clear_kb_buffer
<span class="line-number"> 282</span>
<span class="line-number"> 283</span>   .cleared:
<span class="line-number"> 284</span>
<span class="line-number"> 285</span>skip_game_state_pregame:
<span class="line-number"> 286</span>
</div>
                                                <div class="comment-column">































</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>GAME</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 288</span>
<span class="line-number"> 289</span>test byte [_GAME_STATE_], GSTATE_GAME
<span class="line-number"> 290</span>jz skip_game_state_game
<span class="line-number"> 291</span>
</div>
                                                <div class="comment-column">



</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>STOP SOUND</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 293</span>stop_game_sound:
<span class="line-number"> 294</span>  test byte [_GAME_STATE_], GSTATE_PREGAME
<span class="line-number"> 295</span>  jnz .skip_stop_sound
<span class="line-number"> 296</span>  test byte [_GAME_STATE_], GSTATE_POSTGAME
<span class="line-number"> 297</span>  jnz .skip_stop_sound
<span class="line-number"> 298</span>    call stop_beep
<span class="line-number"> 299</span>  .skip_stop_sound:
<span class="line-number"> 300</span>
<span class="line-number"> 301</span>
<span class="line-number"> 302</span>test byte [_GAME_STATE_], GSTATE_PREGAME
<span class="line-number"> 303</span>jnz skip_keyboard
<span class="line-number"> 304</span>test byte [_GAME_STATE_], GSTATE_POSTGAME
<span class="line-number"> 305</span>jnz skip_keyboard
<span class="line-number"> 306</span>
</div>
                                                <div class="comment-column">













</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>DRAW SHIP</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 308</span>
<span class="line-number"> 309</span>draw_ship_in_game:
<span class="line-number"> 310</span>  mov di, 320*52+32
<span class="line-number"> 311</span>  xor bx, bx
<span class="line-number"> 312</span>  call draw_ship
<span class="line-number"> 313</span>
</div>
                                                <div class="comment-column">





</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>KEYBOARD INPUT</h3>
                                            <div class="sectionDescription">cmp cl, 0x0
jz .invalid_move
jmp .check_move
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 315</span>
<span class="line-number"> 316</span>check_keyboard:
<span class="line-number"> 317</span>  mov ah, 01h         
<span class="line-number"> 318</span>  int 16h             
<span class="line-number"> 319</span>  jz .no_key_press           
<span class="line-number"> 320</span>
<span class="line-number"> 321</span>  mov ah, 00h         
<span class="line-number"> 322</span>  int 16h             
<span class="line-number"> 323</span>
<span class="line-number"> 324</span>  mov si, [_PLAYER_ENTITY_ID_]
<span class="line-number"> 325</span>  mov cx, [si+_POS_]   
<span class="line-number"> 326</span>  mov bx, [si+_POS_OLD_]
<span class="line-number"> 327</span>  cmp cx, bx
<span class="line-number"> 328</span>  jnz .no_key_press
<span class="line-number"> 329</span>
<span class="line-number"> 330</span>
<span class="line-number"> 331</span>  .check_spacebar:
<span class="line-number"> 332</span>  cmp ah, 39h         
<span class="line-number"> 333</span>  jne .check_up
<span class="line-number"> 334</span>    cmp byte [_HOLDING_ID_], 0x0
<span class="line-number"> 335</span>    jz .set_request_position_to_player
<span class="line-number"> 336</span>    mov byte [_HOLDING_ID_], 0x0
<span class="line-number"> 337</span>    jmp .no_key_press
<span class="line-number"> 338</span>    .set_request_position_to_player:
<span class="line-number"> 339</span>      mov word [_REQUEST_POSITION_], cx
<span class="line-number"> 340</span>    jmp .no_key_press
<span class="line-number"> 341</span>  .check_up:
<span class="line-number"> 342</span>  cmp ah, 48h         
<span class="line-number"> 343</span>  jne .check_down
<span class="line-number"> 344</span>    cmp ch, 0x0
<span class="line-number"> 345</span>    jz .invalid_move
<span class="line-number"> 346</span>    dec ch
<span class="line-number"> 347</span>    jmp .check_move
<span class="line-number"> 348</span>
<span class="line-number"> 349</span>  .check_down:
<span class="line-number"> 350</span>  cmp ah, 50h         
<span class="line-number"> 351</span>  jne .check_left
<span class="line-number"> 352</span>    inc ch
<span class="line-number"> 353</span>    jmp .check_move
<span class="line-number"> 354</span>
<span class="line-number"> 355</span>  .check_left:
<span class="line-number"> 356</span>  cmp ah, 4Bh         
<span class="line-number"> 357</span>  jne .check_right
<span class="line-number"> 360</span>    dec cl
<span class="line-number"> 361</span>    mov byte [si+_MIRROR_], 0x1
<span class="line-number"> 362</span>    jmp .check_move
<span class="line-number"> 363</span>
<span class="line-number"> 364</span>
<span class="line-number"> 365</span>  .check_right:
<span class="line-number"> 366</span>  cmp ah, 4Dh         
<span class="line-number"> 367</span>  jne .no_key_press
<span class="line-number"> 368</span>    inc cl
<span class="line-number"> 369</span>    mov byte [si+_MIRROR_], 0x0
<span class="line-number"> 371</span>
<span class="line-number"> 372</span>  .check_move:
<span class="line-number"> 373</span>    call check_friends
<span class="line-number"> 374</span>    jz .no_move
<span class="line-number"> 375</span>    call check_water_tile
<span class="line-number"> 376</span>    jz .no_move
<span class="line-number"> 377</span>    call check_bounds
<span class="line-number"> 378</span>   jz .no_move
<span class="line-number"> 379</span>
<span class="line-number"> 380</span>    .move:
<span class="line-number"> 381</span>    cmp byte [_WEB_LOCKED_], 0
<span class="line-number"> 382</span>    jz .skip_web_check
<span class="line-number"> 383</span>      dec byte [_WEB_LOCKED_]
<span class="line-number"> 384</span>      mov bl, BEEP_WEB
<span class="line-number"> 385</span>      call beep
<span class="line-number"> 386</span>      jmp .no_move
<span class="line-number"> 387</span>    .skip_web_check:
<span class="line-number"> 388</span>    mov word [si+_POS_], cx
<span class="line-number"> 389</span>    mov bl, BEEP_STEP
<span class="line-number"> 390</span>    call beep
<span class="line-number"> 391</span>
<span class="line-number"> 392</span>    .no_move:
<span class="line-number"> 393</span>    mov word [_REQUEST_POSITION_], cx
<span class="line-number"> 394</span>
<span class="line-number"> 395</span>  .no_key_press:
<span class="line-number"> 396</span>  .invalid_move:
<span class="line-number"> 397</span>
<span class="line-number"> 398</span>skip_keyboard:
<span class="line-number"> 399</span>
</div>
                                                <div class="comment-column">

; BIOS keyboard status function
; Call BIOS interrupt
; Jump if Zero Flag is set (no key pressed)

; BIOS keyboard read function
; Call BIOS interrupt


; Load player position into CX (Y in CH, X in CL)






; Compare scan code with spacebar









; Compare scan code with up arrow







; Compare scan code with down arrow





; Compare scan code with left arrow







; Compare scan code with right arrow
































</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>AI ENITIES</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 401</span>
<span class="line-number"> 402</span>ai_entities:
<span class="line-number"> 403</span>  mov si, _ENTITIES_
<span class="line-number"> 404</span>  mov byte cl, [_MAX_ENTITIES_]
<span class="line-number"> 405</span>  .next_entity:
<span class="line-number"> 406</span>    push cx
<span class="line-number"> 407</span>
<span class="line-number"> 408</span>    cmp byte [si+_STATE_], STATE_EXPLORING
<span class="line-number"> 409</span>    jnz .skip_explore
<span class="line-number"> 410</span>
<span class="line-number"> 411</span>    mov ax, [si+_POS_]
<span class="line-number"> 412</span>    mov bx, [si+_POS_OLD_]
<span class="line-number"> 413</span>    cmp ax, bx
<span class="line-number"> 414</span>    jnz .skip_explore
<span class="line-number"> 415</span>
<span class="line-number"> 416</span>      .explore:
<span class="line-number"> 417</span>        mov cx, [si+_POS_]
<span class="line-number"> 418</span>        mov al, [si+_DIR_]
<span class="line-number"> 419</span>
<span class="line-number"> 420</span>        .check_horizontal:
<span class="line-number"> 421</span>        cmp al, 0
<span class="line-number"> 422</span>        jnz .go_left
<span class="line-number"> 423</span>        .go_right:
<span class="line-number"> 424</span>           inc cl
<span class="line-number"> 425</span>           jmp .check_mirror
<span class="line-number"> 426</span>        .go_left:
<span class="line-number"> 427</span>         cmp al, 1
<span class="line-number"> 428</span>         jnz .check_vertical
<span class="line-number"> 429</span>           dec cl
<span class="line-number"> 430</span>           jmp .check_mirror
<span class="line-number"> 431</span>
<span class="line-number"> 432</span>        .check_vertical:
<span class="line-number"> 433</span>        cmp al, 2
<span class="line-number"> 434</span>        jnz .go_up
<span class="line-number"> 435</span>        .go_down:
<span class="line-number"> 436</span>          inc ch
<span class="line-number"> 437</span>          jmp .check_mirror
<span class="line-number"> 438</span>        .go_up:
<span class="line-number"> 439</span>         cmp al, 3
<span class="line-number"> 440</span>         jnz .check_mirror
<span class="line-number"> 441</span>           dec ch
<span class="line-number"> 442</span>
<span class="line-number"> 443</span>        .check_mirror:
<span class="line-number"> 444</span>          mov byte [si+_MIRROR_], 0x0
<span class="line-number"> 445</span>          cmp byte cl, [si+_POS_]
<span class="line-number"> 446</span>          jg .skip_mirror_x
<span class="line-number"> 447</span>          mov byte [si+_MIRROR_], 0x1
<span class="line-number"> 448</span>          .skip_mirror_x:
<span class="line-number"> 449</span>
<span class="line-number"> 450</span>        call check_bounds
<span class="line-number"> 451</span>        jz .can_not_move
<span class="line-number"> 452</span>
<span class="line-number"> 453</span>        call check_friends
<span class="line-number"> 454</span>        jz .can_not_move
<span class="line-number"> 455</span>
<span class="line-number"> 456</span>        call check_water_tile
<span class="line-number"> 457</span>        jz .can_not_move
<span class="line-number"> 458</span>
<span class="line-number"> 459</span>        .move_to_new_pos:
<span class="line-number"> 460</span>          mov word [si+_POS_], cx
<span class="line-number"> 461</span>          jmp .after_move
<span class="line-number"> 462</span>
<span class="line-number"> 463</span>        .can_not_move:
<span class="line-number"> 464</span>
<span class="line-number"> 465</span>        .check_if_crab:
<span class="line-number"> 466</span>        cmp byte [si+_ID_], ID_CRAB
<span class="line-number"> 467</span>        jnz .not_a_crab
<span class="line-number"> 468</span>          xor byte [si+_DIR_], 1
<span class="line-number"> 469</span>          jmp .skip_random_bounce
<span class="line-number"> 470</span>        .not_a_crab:
<span class="line-number"> 471</span>
<span class="line-number"> 472</span>        .random_bounce:
<span class="line-number"> 473</span>           in al, 0x40
<span class="line-number"> 474</span>           add ax, [_GAME_TICK_]
<span class="line-number"> 475</span>           and al, 0x3
<span class="line-number"> 476</span>           mov byte [si+_DIR_], al
<span class="line-number"> 477</span>
<span class="line-number"> 478</span>        .skip_random_bounce:
<span class="line-number"> 479</span>
<span class="line-number"> 480</span>        .check_if_player:
<span class="line-number"> 481</span>          cmp cx, [_REQUEST_POSITION_]
<span class="line-number"> 482</span>          jnz .no_bite
<span class="line-number"> 483</span>            cmp byte [_HOLDING_ID_], 0x0
<span class="line-number"> 484</span>            jnz .continue_game
<span class="line-number"> 485</span>              mov byte [_HOLDING_ID_], 0xff
<span class="line-number"> 486</span>              mov bl, BEEP_BITE
<span class="line-number"> 487</span>              call beep
<span class="line-number"> 488</span>
<span class="line-number"> 489</span>              cmp byte [si+_ID_], ID_SNAKE
<span class="line-number"> 490</span>              jz .snake_bite
<span class="line-number"> 491</span>              cmp byte [si+_ID_], ID_SPIDER
<span class="line-number"> 492</span>              jz .spider_web
<span class="line-number"> 493</span>              cmp byte [si+_ID_], ID_CRAB
<span class="line-number"> 494</span>              jz .crab_bite
<span class="line-number"> 495</span>              jmp .continue_game
<span class="line-number"> 496</span>
<span class="line-number"> 497</span>              .crab_bite:                 
<span class="line-number"> 498</span>              .snake_bite:                
<span class="line-number"> 499</span>                dec byte [_LIFE_]
<span class="line-number"> 500</span>                jnz .continue_game
<span class="line-number"> 501</span>
<span class="line-number"> 502</span>                mov byte [_GAME_STATE_], GSTATE_END
<span class="line-number"> 503</span>                mov word [_CURRENT_TUNE_], tune_end
<span class="line-number"> 504</span>                mov word [_NEXT_TUNE_], tune_end
<span class="line-number"> 505</span>                mov byte [_NOTE_TIMER_], 0x0
<span class="line-number"> 506</span>                mov byte [_NOTE_TEMPO_], 0xa
<span class="line-number"> 507</span>                jmp .skip_item
<span class="line-number"> 508</span>
<span class="line-number"> 509</span>              .spider_web:                
<span class="line-number"> 510</span>                  mov byte [_WEB_LOCKED_] , WEB_LOCK
<span class="line-number"> 511</span>              jmp .continue_game
<span class="line-number"> 512</span>
<span class="line-number"> 513</span>            .continue_game:
<span class="line-number"> 514</span>              mov byte [_HOLDING_ID_], 0x00
<span class="line-number"> 515</span>              jmp .skip_item
<span class="line-number"> 516</span>          .no_bite:
<span class="line-number"> 517</span>          .after_move:
<span class="line-number"> 518</span>    .skip_explore:
<span class="line-number"> 519</span>
<span class="line-number"> 520</span>    cmp byte [si+_STATE_], STATE_INTERACTIVE
<span class="line-number"> 521</span>    jnz .skip_item
<span class="line-number"> 522</span>      mov cx, [si+_POS_]
<span class="line-number"> 523</span>      cmp cx, [_REQUEST_POSITION_]
<span class="line-number"> 524</span>      jnz .skip_item
<span class="line-number"> 525</span>
<span class="line-number"> 526</span>      cmp byte [si+_ID_], ID_BRIDGE
<span class="line-number"> 527</span>      jz .check_bridge
<span class="line-number"> 528</span>      cmp byte [si+_ID_], ID_CHEST
<span class="line-number"> 529</span>      jnz .skip_check_interactions
<span class="line-number"> 530</span>
<span class="line-number"> 531</span>      .check_interactions:
<span class="line-number"> 532</span>        cmp byte [_HOLDING_ID_], ID_GOLD
<span class="line-number"> 533</span>        jnz .skip_item
<span class="line-number"> 534</span>        inc byte [_SCORE_]
<span class="line-number"> 535</span>        mov bl, BEEP_GOLD
<span class="line-number"> 536</span>        call beep
<span class="line-number"> 537</span>        jmp .clear_item
<span class="line-number"> 538</span>
<span class="line-number"> 539</span>      .check_bridge:
<span class="line-number"> 540</span>        cmp byte [_HOLDING_ID_], ID_ROCK
<span class="line-number"> 541</span>        jnz .skip_item
<span class="line-number"> 542</span>        mov byte [si+_STATE_], STATE_DEACTIVATED
<span class="line-number"> 543</span>      .clear_item:
<span class="line-number"> 544</span>          mov byte [_HOLDING_ID_], 0xff
<span class="line-number"> 545</span>          jmp .skip_item
<span class="line-number"> 546</span>      .skip_check_interactions:
<span class="line-number"> 547</span>
<span class="line-number"> 548</span>      cmp byte [_HOLDING_ID_], 0x0  
<span class="line-number"> 549</span>      jnz .skip_item
<span class="line-number"> 550</span>      .pick_item:
<span class="line-number"> 551</span>        mov byte [si+_STATE_], STATE_FOLLOW
<span class="line-number"> 552</span>        mov word [_REQUEST_POSITION_], 0x0
<span class="line-number"> 553</span>        mov byte cl, [si+_ID_]
<span class="line-number"> 554</span>        mov byte [_HOLDING_ID_], cl
<span class="line-number"> 555</span>        mov bl, BEEP_PICK
<span class="line-number"> 556</span>        call beep
<span class="line-number"> 557</span>    .skip_item:
<span class="line-number"> 558</span>
<span class="line-number"> 559</span>    .put_item_back:
<span class="line-number"> 560</span>    cmp byte [si+_STATE_], STATE_FOLLOW
<span class="line-number"> 561</span>    jnz .no_follow
<span class="line-number"> 562</span>
<span class="line-number"> 563</span>      cmp byte [_HOLDING_ID_], 0x0
<span class="line-number"> 564</span>      jnz .check_kill
<span class="line-number"> 565</span>        mov byte [si+_STATE_], STATE_INTERACTIVE
<span class="line-number"> 566</span>        mov word [_REQUEST_POSITION_], 0x0
<span class="line-number"> 567</span>        jmp .beep
<span class="line-number"> 568</span>
<span class="line-number"> 569</span>      .check_kill:
<span class="line-number"> 570</span>      cmp byte [_HOLDING_ID_], 0xff
<span class="line-number"> 571</span>      jnz .skip_kill
<span class="line-number"> 572</span>        mov byte [si+_STATE_], STATE_DEACTIVATED
<span class="line-number"> 573</span>        mov byte [_HOLDING_ID_], 0x0
<span class="line-number"> 574</span>      .beep:
<span class="line-number"> 575</span>      mov bl, BEEP_PUT
<span class="line-number"> 576</span>      call beep
<span class="line-number"> 577</span>    .skip_kill:
<span class="line-number"> 578</span>    .no_follow:
<span class="line-number"> 579</span>
<span class="line-number"> 580</span>    add si, ENTITY_SIZE
<span class="line-number"> 581</span>    pop cx
<span class="line-number"> 582</span>    dec cx
<span class="line-number"> 583</span>  jnz .next_entity
<span class="line-number"> 584</span>
</div>
                                                <div class="comment-column">































































































; Crab
; Snake










; Spider






































; Check if player is holding something




































</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>SORT ENITIES</h3>
                                            <div class="sectionDescription">Sort entities by Y position
Expects: entities array
Returns: sorted entities array
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 589</span>
<span class="line-number"> 590</span>sort_entities:
<span class="line-number"> 591</span>  mov cl, [_MAX_ENTITIES_]
<span class="line-number"> 592</span>  dec cl  
<span class="line-number"> 593</span>  .outer_loop:
<span class="line-number"> 594</span>    push cx
<span class="line-number"> 595</span>    mov si, _ENTITIES_
<span class="line-number"> 596</span>
<span class="line-number"> 597</span>    .inner_loop:
<span class="line-number"> 598</span>      push cx
<span class="line-number"> 599</span>      mov bx, [si+_POS_]  
<span class="line-number"> 600</span>      mov dx, [si+ENTITY_SIZE+_POS_]  
<span class="line-number"> 601</span>
<span class="line-number"> 602</span>      cmp bh, dh      
<span class="line-number"> 603</span>      jle .no_swap
<span class="line-number"> 604</span>
<span class="line-number"> 605</span>        mov di, si
<span class="line-number"> 606</span>        add di, ENTITY_SIZE
<span class="line-number"> 607</span>
<span class="line-number"> 608</span>        mov ax, [_PLAYER_ENTITY_ID_]
<span class="line-number"> 609</span>        cmp ax, si
<span class="line-number"> 610</span>        jne .check_next_entity
<span class="line-number"> 611</span>          mov [_PLAYER_ENTITY_ID_], di
<span class="line-number"> 612</span>          jmp .swap_entities
<span class="line-number"> 613</span>        .check_next_entity:
<span class="line-number"> 614</span>        cmp ax, di
<span class="line-number"> 615</span>        jne .swap_entities
<span class="line-number"> 616</span>          mov [_PLAYER_ENTITY_ID_], si
<span class="line-number"> 617</span>        .swap_entities:
<span class="line-number"> 618</span>
<span class="line-number"> 619</span>        mov cx, ENTITY_SIZE
<span class="line-number"> 620</span>        .swap_loop:
<span class="line-number"> 621</span>          mov al, [si]
<span class="line-number"> 622</span>          xchg al, [di]
<span class="line-number"> 623</span>          mov [si], al
<span class="line-number"> 624</span>          inc si
<span class="line-number"> 625</span>          inc di
<span class="line-number"> 626</span>          loop .swap_loop
<span class="line-number"> 627</span>        sub si, ENTITY_SIZE
<span class="line-number"> 628</span>
<span class="line-number"> 629</span>      .no_swap:
<span class="line-number"> 630</span>      add si, ENTITY_SIZE
<span class="line-number"> 631</span>      pop cx
<span class="line-number"> 632</span>      loop .inner_loop
<span class="line-number"> 633</span>
<span class="line-number"> 634</span>    pop cx
<span class="line-number"> 635</span>    loop .outer_loop
<span class="line-number"> 636</span>
</div>
                                                <div class="comment-column">


; We'll do n-1 passes






; Get Y of current entity
; Get Y of next entity

; Compare Y values


































</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>DRAW ENITIES</h3>
                                            <div class="sectionDescription">smooth move here
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 638</span>
<span class="line-number"> 639</span>draw_entities:
<span class="line-number"> 640</span>  mov si, _ENTITIES_
<span class="line-number"> 641</span>  mov byte cl, [_MAX_ENTITIES_]
<span class="line-number"> 642</span>  .next:
<span class="line-number"> 643</span>    push cx
<span class="line-number"> 644</span>    push si
<span class="line-number"> 645</span>
<span class="line-number"> 646</span>    cmp byte [si+_STATE_], STATE_DEACTIVATED
<span class="line-number"> 647</span>    jz .skip_entity
<span class="line-number"> 648</span>
<span class="line-number"> 649</span>    test byte [_GAME_STATE_], GSTATE_PREGAME
<span class="line-number"> 650</span>    jnz .hide_player
<span class="line-number"> 651</span>    test byte [_GAME_STATE_], GSTATE_POSTGAME
<span class="line-number"> 652</span>    jnz .hide_player
<span class="line-number"> 653</span>    jmp .skip_hide_player
<span class="line-number"> 654</span>    .hide_player:
<span class="line-number"> 655</span>      cmp byte [si+_ID_], ID_PLAYER
<span class="line-number"> 656</span>      jz .skip_entity
<span class="line-number"> 657</span>      cmp byte [si+_ID_], ID_CHEST
<span class="line-number"> 658</span>      jz .skip_entity
<span class="line-number"> 659</span>    .skip_hide_player:
<span class="line-number"> 660</span>
<span class="line-number"> 662</span>    mov ax, [si+_POS_OLD_]
<span class="line-number"> 663</span>    mov cx, [si+_POS_]
<span class="line-number"> 664</span>    cmp cx, ax
<span class="line-number"> 665</span>    jz .in_position
<span class="line-number"> 666</span>
<span class="line-number"> 667</span>       xor bx, bx
<span class="line-number"> 668</span>
<span class="line-number"> 669</span>       cmp al, cl
<span class="line-number"> 670</span>       jl .move_left
<span class="line-number"> 671</span>       jg .move_right
<span class="line-number"> 672</span>       cmp ah, ch
<span class="line-number"> 673</span>       jl .move_down
<span class="line-number"> 674</span>       jg .move_up
<span class="line-number"> 675</span>
<span class="line-number"> 676</span>       jmp .in_position
<span class="line-number"> 677</span>
<span class="line-number"> 678</span>        .move_left:
<span class="line-number"> 679</span>        add bx, ENTITIES_SPEED
<span class="line-number"> 680</span>        jmp .save_move
<span class="line-number"> 681</span>
<span class="line-number"> 682</span>        .move_right:
<span class="line-number"> 683</span>        sub bx, ENTITIES_SPEED
<span class="line-number"> 684</span>        jmp .save_move
<span class="line-number"> 685</span>
<span class="line-number"> 686</span>        .move_down:
<span class="line-number"> 687</span>        add bx, 320*ENTITIES_SPEED
<span class="line-number"> 688</span>        jmp .save_move
<span class="line-number"> 689</span>
<span class="line-number"> 690</span>        .move_up:
<span class="line-number"> 691</span>        sub bx, 320*ENTITIES_SPEED
<span class="line-number"> 692</span>        jmp .save_move
<span class="line-number"> 693</span>
<span class="line-number"> 694</span>       .save_move:
<span class="line-number"> 695</span>       mov cx, [si+_POS_]
<span class="line-number"> 696</span>       call conv_pos2mem
<span class="line-number"> 697</span>       mov dx, di
<span class="line-number"> 698</span>       add [si+_SCREEN_POS_], bx
<span class="line-number"> 699</span>       mov di, [si+_SCREEN_POS_]
<span class="line-number"> 700</span>       cmp dx, di
<span class="line-number"> 701</span>       jnz .pos_calculated
<span class="line-number"> 702</span>       mov cx, [si+_POS_]
<span class="line-number"> 703</span>       mov [si+_POS_OLD_], cx
<span class="line-number"> 704</span>       mov byte [si+_ANIM_], 0x0
<span class="line-number"> 705</span>       cmp byte [si+_ID_], ID_PLAYER
<span class="line-number"> 706</span>       jnz .skip_step_beep
<span class="line-number"> 707</span>       mov bl, BEEP_STEP
<span class="line-number"> 708</span>       call beep
<span class="line-number"> 709</span>       .skip_step_beep:
<span class="line-number"> 710</span>
<span class="line-number"> 711</span>
<span class="line-number"> 712</span>    .in_position:
<span class="line-number"> 713</span>    call conv_pos2mem  
<span class="line-number"> 714</span>    .pos_calculated:
<span class="line-number"> 715</span>    cmp byte [si+_STATE_], STATE_FOLLOW
<span class="line-number"> 716</span>    jnz .skip_follow
<span class="line-number"> 717</span>      push si
<span class="line-number"> 718</span>      mov si, [_PLAYER_ENTITY_ID_]
<span class="line-number"> 719</span>      mov cx, [si+_POS_]   
<span class="line-number"> 720</span>      mov di, [si+_SCREEN_POS_]
<span class="line-number"> 721</span>      sub di, 320*14          
<span class="line-number"> 722</span>      pop si
<span class="line-number"> 723</span>      mov word [si+_POS_], cx 
<span class="line-number"> 724</span>      jmp .skip_draw_shadow
<span class="line-number"> 725</span>    .skip_follow:
<span class="line-number"> 726</span>
<span class="line-number"> 727</span>
<span class="line-number"> 728</span>    .draw_shadow:
<span class="line-number"> 729</span>    test byte [si+_STATE_], STATE_EXPLORING
<span class="line-number"> 730</span>    jnz .skip_draw_shadow
<span class="line-number"> 731</span>    cmp byte [si+_ID_], ID_PLAYER
<span class="line-number"> 732</span>    jz .skip_draw_shadow
<span class="line-number"> 733</span>    cmp byte [si+_ID_], ID_BRIDGE
<span class="line-number"> 734</span>    jz .skip_draw_shadow
<span class="line-number"> 735</span>    push si
<span class="line-number"> 736</span>    push di
<span class="line-number"> 737</span>    mov si, ShadowBrush
<span class="line-number"> 738</span>    add di, 320*5+1
<span class="line-number"> 739</span>    call draw_sprite
<span class="line-number"> 740</span>    pop di
<span class="line-number"> 741</span>    pop si
<span class="line-number"> 742</span>    .skip_draw_shadow:
<span class="line-number"> 743</span>
<span class="line-number"> 744</span>    mov byte al, [si]       
<span class="line-number"> 745</span>    mov ah, al              
<span class="line-number"> 746</span>
<span class="line-number"> 747</span>    shl al, 0x2
<span class="line-number"> 748</span>    mov bx, BrushRefs       
<span class="line-number"> 749</span>    add bl, al              
<span class="line-number"> 750</span>    mov dx, [bx]            
<span class="line-number"> 751</span>
<span class="line-number"> 752</span>    push dx                 
<span class="line-number"> 753</span>
<span class="line-number"> 754</span>    add al, 0x2               
<span class="line-number"> 755</span>    movzx bx, al              
<span class="line-number"> 756</span>    add di, [BrushRefs + bx]  
<span class="line-number"> 757</span>    mov dl, [si+_MIRROR_]     
<span class="line-number"> 758</span>
<span class="line-number"> 759</span>    cmp ah, ID_PLAYER
<span class="line-number"> 760</span>    jnz .skip_player_anim
<span class="line-number"> 761</span>      mov ax, [si+_POS_]
<span class="line-number"> 762</span>      cmp ax, [si+_POS_OLD_]
<span class="line-number"> 763</span>      mov ah, ID_PLAYER
<span class="line-number"> 764</span>      jz .skip_player_anim
<span class="line-number"> 765</span>        xor byte [si+_ANIM_], 0x1
<span class="line-number"> 766</span>    .skip_player_anim:
<span class="line-number"> 767</span>
<span class="line-number"> 768</span>    mov dh, [si+_ANIM_]       
<span class="line-number"> 769</span>
<span class="line-number"> 770</span>    pop si                  
<span class="line-number"> 771</span>    call draw_sprite
<span class="line-number"> 772</span>
<span class="line-number"> 773</span>    cmp ah, ID_PLAYER
<span class="line-number"> 774</span>    jnz .skip_player_draw
<span class="line-number"> 775</span>      mov si, IndieTopBrush
<span class="line-number"> 776</span>      sub di, 320*4
<span class="line-number"> 777</span>
<span class="line-number"> 778</span>      cmp dh, 0x1       
<span class="line-number"> 779</span>      jnz .skip_anim_move
<span class="line-number"> 780</span>        add di, 320
<span class="line-number"> 781</span>      .skip_anim_move:
<span class="line-number"> 782</span>
<span class="line-number"> 783</span>      cmp byte [_HOLDING_ID_], 0x0
<span class="line-number"> 784</span>      jz .skip_player_holding
<span class="line-number"> 785</span>         mov si, IndieTop2Brush
<span class="line-number"> 786</span>      .skip_player_holding:
<span class="line-number"> 787</span>
<span class="line-number"> 788</span>      xor dh, dh
<span class="line-number"> 789</span>      call draw_sprite
<span class="line-number"> 790</span>
<span class="line-number"> 791</span>      cmp byte [_WEB_LOCKED_], 0
<span class="line-number"> 792</span>      jz .skip_web_draw
<span class="line-number"> 793</span>        mov si, WebBrush
<span class="line-number"> 794</span>        add di, 320*6
<span class="line-number"> 795</span>        call draw_sprite
<span class="line-number"> 796</span>      .skip_web_draw:
<span class="line-number"> 797</span>    .skip_player_draw:
<span class="line-number"> 798</span>
<span class="line-number"> 799</span>    cmp ah, ID_GOLD
<span class="line-number"> 800</span>    jnz .skip_gold_draw
<span class="line-number"> 801</span>      mov ax, [_GAME_TICK_]
<span class="line-number"> 802</span>      add ax, cx
<span class="line-number"> 803</span>      and ax, 0x4
<span class="line-number"> 804</span>      cmp ax, 0x2
<span class="line-number"> 805</span>      jl .skip_gold_draw
<span class="line-number"> 806</span>      xor dx, dx 
<span class="line-number"> 807</span>      mov si, GoldBrush
<span class="line-number"> 808</span>      call draw_sprite
<span class="line-number"> 809</span>    .skip_gold_draw:
<span class="line-number"> 810</span>
<span class="line-number"> 811</span>    cmp ah, ID_CRAB
<span class="line-number"> 812</span>    jnz .skip_crab
<span class="line-number"> 813</span>      mov dx, 0
<span class="line-number"> 814</span>      mov si, CrabClawBrush
<span class="line-number"> 815</span>      add di, 8
<span class="line-number"> 816</span>      call draw_sprite
<span class="line-number"> 817</span>      mov dx, 1
<span class="line-number"> 818</span>      sub di, 320+16
<span class="line-number"> 819</span>      call draw_sprite
<span class="line-number"> 820</span>    .skip_crab:
<span class="line-number"> 821</span>
<span class="line-number"> 822</span>    cmp ah, ID_CHEST
<span class="line-number"> 823</span>    jnz .skip_chest
<span class="line-number"> 824</span>     xor dx,dx
<span class="line-number"> 825</span>      cmp byte [_HOLDING_ID_], ID_GOLD
<span class="line-number"> 826</span>      jnz .skip_open_chest
<span class="line-number"> 827</span>        mov si, ChestTopBrush
<span class="line-number"> 828</span>        sub di, 320*3+8
<span class="line-number"> 829</span>        call draw_sprite
<span class="line-number"> 830</span>
<span class="line-number"> 831</span>        mov si, ArrowBrush
<span class="line-number"> 832</span>        sub di, 320*8-8
<span class="line-number"> 833</span>        mov ax, [_GAME_TICK_]
<span class="line-number"> 834</span>        and ax, 0x1
<span class="line-number"> 835</span>        imul ax, 320*2
<span class="line-number"> 836</span>        add di, ax
<span class="line-number"> 837</span>        call draw_sprite
<span class="line-number"> 838</span>        jmp .skip_chest
<span class="line-number"> 839</span>        .skip_open_chest:
<span class="line-number"> 840</span>            mov si, ChestCloseBrush
<span class="line-number"> 841</span>            sub di, 320
<span class="line-number"> 842</span>            call draw_sprite
<span class="line-number"> 843</span>    .skip_chest:
<span class="line-number"> 844</span>
<span class="line-number"> 845</span>    .skip_entity:
<span class="line-number"> 846</span>    pop si
<span class="line-number"> 847</span>    add si, ENTITY_SIZE
<span class="line-number"> 848</span>    pop cx
<span class="line-number"> 849</span>    dec cx
<span class="line-number"> 850</span>  jg .next
<span class="line-number"> 851</span>
</div>
                                                <div class="comment-column">









































































; screen pos in DI





; Load player position into CX (Y in CH, X in CL)

; Move above player

; Save new position to holding item




















; Get brush id in AL
; Save a copy in AH


; Get brush reference table
; Shift to ref (id*2 bytes)
; Get brush data address

; Save address for SI

; offest is at next byte (+2)
; Get address to BX
; Get shift and apply to destination position
; Get brush mirror flag










; Get anination frame

; Get address







; move head down on second frame



























; no mirror













































</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>CHECK SCORE</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 853</span>
<span class="line-number"> 854</span>test byte [_GAME_STATE_], GSTATE_PREGAME
<span class="line-number"> 855</span>jnz skip_score
<span class="line-number"> 856</span>test byte [_GAME_STATE_], GSTATE_POSTGAME
<span class="line-number"> 857</span>jnz skip_score
<span class="line-number"> 858</span>
<span class="line-number"> 859</span>check_score:
<span class="line-number"> 860</span>  mov di, SCORE_POSITION
<span class="line-number"> 861</span>  mov al, [_SCORE_TARGET_]
<span class="line-number"> 862</span>  mov ah, [_SCORE_]
<span class="line-number"> 863</span>  cmp al, ah
<span class="line-number"> 864</span>  jg .continue_game
<span class="line-number"> 865</span>    add byte [_GAME_STATE_], GSTATE_POSTGAME
<span class="line-number"> 866</span>    mov word [_GAME_TICK_], 0x0
<span class="line-number"> 867</span>    mov word [_CURRENT_TUNE_], tune_win
<span class="line-number"> 868</span>    mov word [_NEXT_TUNE_], tune_win
<span class="line-number"> 869</span>    mov byte [_NOTE_TIMER_], 0x0
<span class="line-number"> 870</span>    mov byte [_NOTE_TEMPO_], 0x2
<span class="line-number"> 871</span>  .continue_game:
<span class="line-number"> 872</span>  
</div>
                                                <div class="comment-column">



















</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>DRAW SCORE</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 874</span>draw_score_ui:
<span class="line-number"> 875</span>mov si, CoinVector
<span class="line-number"> 876</span>mov bp, 320*10+100
<span class="line-number"> 877</span>xor cl, cl
<span class="line-number"> 878</span>  .draw_spot:
<span class="line-number"> 879</span>      mov word [_VECTOR_COLOR_], 0x1213
<span class="line-number"> 880</span>      cmp cl, ah
<span class="line-number"> 881</span>      jge .skip_gold_draw
<span class="line-number"> 882</span>          mov word [_VECTOR_COLOR_], 0x4344
<span class="line-number"> 883</span>      .skip_gold_draw:
<span class="line-number"> 884</span>          add bp, 22
<span class="line-number"> 885</span>          call draw_vector
<span class="line-number"> 886</span>    add di, 0xa
<span class="line-number"> 887</span>    inc cl
<span class="line-number"> 888</span>    cmp al, cl
<span class="line-number"> 889</span>  jnz .draw_spot
<span class="line-number"> 890</span>
<span class="line-number"> 891</span>
<span class="line-number"> 892</span>draw_life_ui:
<span class="line-number"> 893</span>  mov ah, [_LIFE_]
<span class="line-number"> 894</span>  mov al, [_LIFE_TARGET_]
<span class="line-number"> 895</span>  
<span class="line-number"> 896</span>  mov si, LifeUIVector
<span class="line-number"> 897</span>  mov bp, 320*10+10
<span class="line-number"> 898</span>  xor cl, cl
<span class="line-number"> 899</span>  .draw_life_spot:
<span class="line-number"> 900</span>      mov word [_VECTOR_COLOR_], 0x8482
<span class="line-number"> 901</span>      cmp cl, ah
<span class="line-number"> 902</span>      jge .skip_life_draw
<span class="line-number"> 903</span>      mov word [_VECTOR_COLOR_], 0x2321
<span class="line-number"> 904</span>      .skip_life_draw:
<span class="line-number"> 905</span>      add bp, 22
<span class="line-number"> 906</span>      call draw_vector
<span class="line-number"> 907</span>    add di, 0xa
<span class="line-number"> 908</span>    inc cl
<span class="line-number"> 909</span>    cmp al, cl
<span class="line-number"> 910</span>  jnz .draw_life_spot
<span class="line-number"> 911</span>
<span class="line-number"> 912</span>skip_score:
<span class="line-number"> 913</span>skip_game_state_game:
<span class="line-number"> 914</span>
<span class="line-number"> 915</span>
</div>
                                                <div class="comment-column">









































</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>POST GAME</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 917</span>
<span class="line-number"> 918</span>test byte [_GAME_STATE_], GSTATE_POSTGAME
<span class="line-number"> 919</span>jz skip_game_state_postgame
<span class="line-number"> 920</span>draw_post_game:
<span class="line-number"> 921</span>  mov ax, [_GAME_TICK_]
<span class="line-number"> 922</span>  shr ax, 1
<span class="line-number"> 923</span>  cmp ax, POST_GAME_TIME
<span class="line-number"> 924</span>  jnz .move_ship
<span class="line-number"> 925</span>    inc byte [_CURRENT_LEVEL_]
<span class="line-number"> 926</span>    cmp byte [_CURRENT_LEVEL_], AVAILABLE_LEVELS
<span class="line-number"> 927</span>    jz restart_game
<span class="line-number"> 928</span>    mov byte [_GAME_STATE_], GSTATE_GAME+GSTATE_PREGAME
<span class="line-number"> 929</span>    mov byte [_SCORE_], 0x0
<span class="line-number"> 930</span>    mov word [_GAME_TICK_], 0x0
<span class="line-number"> 931</span>    mov byte [_HOLDING_ID_], 0x0
<span class="line-number"> 932</span>    mov byte [_WEB_LOCKED_], 0x0
<span class="line-number"> 933</span>    mov word [_CURRENT_TUNE_], tune_intro
<span class="line-number"> 934</span>    mov word [_NEXT_TUNE_], tune_intro           
<span class="line-number"> 935</span>    mov byte [_NOTE_TIMER_], 0x0
<span class="line-number"> 936</span>    call draw_level
<span class="line-number"> 937</span>    call spawn_entities
<span class="line-number"> 938</span>  .move_ship:
<span class="line-number"> 939</span>  mov di, 320*52+32
<span class="line-number"> 940</span>  add di, ax
<span class="line-number"> 941</span>  mov bx, 0x1
<span class="line-number"> 942</span>  call draw_ship
<span class="line-number"> 943</span>  call play_tune
<span class="line-number"> 944</span>
<span class="line-number"> 945</span>
<span class="line-number"> 946</span>skip_game_state_postgame:
<span class="line-number"> 947</span>
</div>
                                                <div class="comment-column">
















; loop intro tune













</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>GAME END</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 949</span>
<span class="line-number"> 950</span>test byte [_GAME_STATE_], GSTATE_END
<span class="line-number"> 951</span>jz skip_game_state_end
<span class="line-number"> 952</span>  call play_tune
<span class="line-number"> 953</span>  mov di, 320*100+154
<span class="line-number"> 954</span>  mov si, SkullBrush
<span class="line-number"> 955</span>  test byte [_GAME_STATE_], GSTATE_WIN
<span class="line-number"> 956</span>  jz .draw_icon
<span class="line-number"> 957</span>  mov si, GoldBrush
<span class="line-number"> 958</span>  .draw_icon:
<span class="line-number"> 959</span>  call draw_sprite
<span class="line-number"> 960</span>
<span class="line-number"> 961</span>  mov ah, 01h         
<span class="line-number"> 962</span>  int 16h             
<span class="line-number"> 963</span>  jz .no_key_press
<span class="line-number"> 964</span>  .restart_game:
<span class="line-number"> 965</span>    test byte [_GAME_STATE_], GSTATE_WIN
<span class="line-number"> 966</span>    jz restart_game
<span class="line-number"> 967</span>    
<span class="line-number"> 968</span>  .no_key_press:
<span class="line-number"> 969</span>skip_game_state_end:
<span class="line-number"> 970</span>
</div>
                                                <div class="comment-column">











; BIOS keyboard status function
; Call BIOS interrupt








</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>VGA BLIT PROCEDURE</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 972</span>
<span class="line-number"> 973</span>vga_blit:
<span class="line-number"> 974</span>    push es
<span class="line-number"> 975</span>    push ds
<span class="line-number"> 976</span>
<span class="line-number"> 977</span>    push _VGA_MEMORY_                     
<span class="line-number"> 978</span>    pop es                                  
<span class="line-number"> 979</span>    push _DBUFFER_MEMORY_                 
<span class="line-number"> 980</span>    pop ds                                  
<span class="line-number"> 981</span>    xor si,si                               
<span class="line-number"> 982</span>    xor di,di                               
<span class="line-number"> 983</span>    
<span class="line-number"> 984</span>    mov cx,0x7D00                           
<span class="line-number"> 985</span>    rep movsw                               
<span class="line-number"> 986</span>
<span class="line-number"> 987</span>    pop ds
<span class="line-number"> 988</span>    pop es
<span class="line-number"> 989</span>
<span class="line-number"> 990</span>
</div>
                                                <div class="comment-column">




; Set VGA memory
; as target
; Set doublebuffer memory
; as source
; Clear SI
; Clear DI

; Half of 320x200 pixels
; Push words (2x pixels)





</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>GAME TICK</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number"> 992</span>
<span class="line-number"> 993</span>wait_for_tick:
<span class="line-number"> 994</span>    xor ax, ax          
<span class="line-number"> 995</span>    int _TICK_          
<span class="line-number"> 996</span>    mov bx, dx          
<span class="line-number"> 997</span>.wait_loop:
<span class="line-number"> 998</span>    int _TICK_          
<span class="line-number"> 999</span>    cmp dx, bx
<span class="line-number">1000</span>    je .wait_loop       
<span class="line-number">1001</span>
<span class="line-number">1002</span>inc word [_GAME_TICK_]  
<span class="line-number">1003</span>
</div>
                                                <div class="comment-column">

; Function 00h: Read system timer counter
; Returns tick count in CX:DX
; Store the current tick count

; Read the tick count again

; Loop until the tick count changes

; Increment game tick

</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>ESC OR LOOP</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1005</span>
<span class="line-number">1006</span>  in al, 0x60                  
<span class="line-number">1007</span>  dec al                      
<span class="line-number">1008</span>  jnz game_loop               
<span class="line-number">1009</span>
</div>
                                                <div class="comment-column">
; Read keyboard
; Decrement AL (esc is 1, after decrement is 0)
; If not zero, loop again

</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>TERMINATE PROGRAM</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1011</span>
<span class="line-number">1012</span>  exit:
<span class="line-number">1013</span>
</div>
                                                <div class="comment-column">


</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>BEEP STOP</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1015</span>
<span class="line-number">1016</span>  call stop_beep
<span class="line-number">1017</span>  mov ax, 0x4c00
<span class="line-number">1018</span>  int 0x21
<span class="line-number">1019</span>  ret                       
<span class="line-number">1020</span>
<span class="line-number">1021</span>
</div>
                                                <div class="comment-column">



; Return to BIOS/DOS


</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>BEEP PC SPEAKER</h3>
                                            <div class="sectionDescription">Set the speaker frequency
Expects: BX - frequency value
Return: -
xor bh, bh
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1026</span>
<span class="line-number">1027</span>beep:
<span class="line-number">1029</span>  mov al, 0xB6  
<span class="line-number">1030</span>  out 0x43, al   
<span class="line-number">1031</span>  mov ah, bl    
<span class="line-number">1032</span>  out 0x42, al   
<span class="line-number">1033</span>  mov al, ah
<span class="line-number">1034</span>  out 0x42, al   
<span class="line-number">1035</span>  in al, 0x61    
<span class="line-number">1036</span>  or al, 0x03    
<span class="line-number">1037</span>  out 0x61, al   
<span class="line-number">1038</span>ret
<span class="line-number">1039</span>
<span class="line-number">1040</span>stop_beep:
<span class="line-number">1041</span>  in al, 0x61    
<span class="line-number">1042</span>  and al, 0x0FC  
<span class="line-number">1043</span>  out 0x61, al   
<span class="line-number">1044</span>ret
<span class="line-number">1045</span>
</div>
                                                <div class="comment-column">

; Command to set the speaker frequency
; Write the command to the PIT chip
; Frequency value
; Write the low byte of the frequency value

; Write the high byte of the frequency value
; Read the PIC chip
; Set bit 0 to enable the speaker
; Write the updated value back to the PIC chip



; Read the PIC chip
; Clear bit 0 to disable the speaker
; Write the updated value back to the PIC chip


</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>PLAY TUNE</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1047</span>play_tune:
<span class="line-number">1048</span>  cmp byte [_NOTE_TIMER_], 0x0
<span class="line-number">1049</span>  jz .new_note
<span class="line-number">1050</span>    dec byte [_NOTE_TIMER_]
<span class="line-number">1051</span>    jmp .done
<span class="line-number">1052</span>  .new_note:
<span class="line-number">1053</span>    inc word [_CURRENT_TUNE_]
<span class="line-number">1054</span>    mov si, [_CURRENT_TUNE_]
<span class="line-number">1055</span>    mov bl, [si]
<span class="line-number">1056</span>    cmp bl, 0
<span class="line-number">1057</span>    jnz .skip_loop
<span class="line-number">1058</span>      mov ax, [_NEXT_TUNE_]
<span class="line-number">1059</span>      mov word [_CURRENT_TUNE_], ax     
<span class="line-number">1060</span>      mov si, ax
<span class="line-number">1061</span>      mov bl, [si]
<span class="line-number">1062</span>    .skip_loop:
<span class="line-number">1063</span>    mov byte al, [_NOTE_TEMPO_]
<span class="line-number">1064</span>    mov byte [_NOTE_TIMER_], al
<span class="line-number">1065</span>    call beep
<span class="line-number">1066</span>  .done:
<span class="line-number">1067</span>ret
<span class="line-number">1068</span>
<span class="line-number">1069</span>draw_clouds:
<span class="line-number">1070</span>  mov word [_VECTOR_COLOR_], 0x5456
<span class="line-number">1071</span>  mov bp, [_GAME_TICK_]
<span class="line-number">1072</span>  shr bp, 4
<span class="line-number">1073</span>  mov si, CloudsVector
<span class="line-number">1074</span>  call draw_vector
<span class="line-number">1075</span>ret
</div>
                                                <div class="comment-column">











; Loop to begining of the tune
















</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>CNVERT XY TO MEM</h3>
                                            <div class="sectionDescription">Expects: CX - position YY/XX
Return: DI memory position
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1079</span>
<span class="line-number">1080</span>conv_pos2mem:
<span class="line-number">1081</span>  mov di, LEVEL_START_POSITION
<span class="line-number">1082</span>  xor ax, ax               
<span class="line-number">1083</span>  mov al, ch               
<span class="line-number">1084</span> imul ax, 320*8
<span class="line-number">1085</span>  xor dh, dh               
<span class="line-number">1086</span>  mov dl, cl               
<span class="line-number">1087</span>  shl dx, 3                
<span class="line-number">1088</span>  add ax, dx               
<span class="line-number">1089</span>  add di, ax               
<span class="line-number">1090</span>ret
<span class="line-number">1091</span>
<span class="line-number">1092</span>
</div>
                                                <div class="comment-column">


; Clear AX
; Move Y coordinate to AL

; Clear DH
; Move X coordinate to DL
; DX = X * 8
; AX = Y * 2560 + X * 8
; Move result to DI



</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>SPAWN ENTITIES</h3>
                                            <div class="sectionDescription">Expects: entities array from level data
Returns: entities in memory array
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1096</span>
<span class="line-number">1097</span>spawn_entities:
<span class="line-number">1098</span>  mov si, Levels
<span class="line-number">1099</span>  mov ax, [_CURRENT_LEVEL_]
<span class="line-number">1100</span>  shl ax, 1
<span class="line-number">1101</span>  add si, ax
<span class="line-number">1102</span>  mov ax, [si]
<span class="line-number">1103</span>  add ax, 128
<span class="line-number">1104</span>  mov si, ax
<span class="line-number">1105</span>  mov di, _ENTITIES_
<span class="line-number">1106</span>  mov byte [_MAX_ENTITIES_], 0x0
<span class="line-number">1107</span>
<span class="line-number">1108</span>  .next_entity:
<span class="line-number">1109</span>    mov bl, [si]       
<span class="line-number">1110</span>    cmp bl, 0x0        
<span class="line-number">1111</span>    jz .done
<span class="line-number">1112</span>
<span class="line-number">1113</span>    
<span class="line-number">1114</span>
<span class="line-number">1115</span>    dec bl             
<span class="line-number">1116</span>
<span class="line-number">1117</span>    inc si
<span class="line-number">1118</span>    mov al, [si]       
<span class="line-number">1119</span>    inc si             
<span class="line-number">1120</span>    mov cl, al         
<span class="line-number">1121</span>
<span class="line-number">1122</span>    cmp bl, ID_GOLD    
<span class="line-number">1123</span>    jnz .not_gold
<span class="line-number">1124</span>    mov [_SCORE_TARGET_], cl 
<span class="line-number">1125</span>    .not_gold:
<span class="line-number">1126</span>
<span class="line-number">1127</span>    .next_in_group:
<span class="line-number">1128</span>      mov byte [di], bl           
<span class="line-number">1129</span>      mov ax, [si]                
<span class="line-number">1130</span>      mov [di+_POS_], ax          
<span class="line-number">1131</span>      mov [di+_POS_OLD_], ax      
<span class="line-number">1132</span>
<span class="line-number">1133</span>      push cx
<span class="line-number">1134</span>      push di
<span class="line-number">1135</span>      mov cx, ax
<span class="line-number">1136</span>      call conv_pos2mem
<span class="line-number">1137</span>      mov ax, di
<span class="line-number">1138</span>      pop di
<span class="line-number">1139</span>      pop cx
<span class="line-number">1140</span>      mov [di+_SCREEN_POS_], ax
<span class="line-number">1141</span>
<span class="line-number">1142</span>      mov byte [di+_MIRROR_], 0x0 
<span class="line-number">1143</span>      mov byte [di+_STATE_], STATE_STATIC 
<span class="line-number">1144</span>      mov byte [di+_DIR_], 0x0 
<span class="line-number">1145</span>      mov byte [di+_ANIM_], 0x0
<span class="line-number">1146</span>
<span class="line-number">1147</span>      cmp bl, ID_SNAKE
<span class="line-number">1148</span>      jz .set_explore
<span class="line-number">1149</span>      cmp bl, ID_CRAB
<span class="line-number">1150</span>      jz .set_explore
<span class="line-number">1151</span>      cmp bl, ID_SPIDER
<span class="line-number">1152</span>      jz .set_explore
<span class="line-number">1153</span>      jmp .skip_explore
<span class="line-number">1154</span>      .set_explore:   
<span class="line-number">1155</span>        mov byte [di+_STATE_], STATE_EXPLORING
<span class="line-number">1156</span>      .skip_explore:
<span class="line-number">1157</span>
<span class="line-number">1158</span>      cmp bl, ID_PALM
<span class="line-number">1159</span>      jz .set_rand_mirror
<span class="line-number">1160</span>      cmp bl, ID_BUSH
<span class="line-number">1161</span>      jz .set_rand_mirror
<span class="line-number">1162</span>      jnz .skip_mirror
<span class="line-number">1163</span>      .set_rand_mirror:  
<span class="line-number">1164</span>        xor al, ah
<span class="line-number">1165</span>        and al, 0x01
<span class="line-number">1166</span>        mov byte [di+_MIRROR_], al
<span class="line-number">1167</span>      .skip_mirror:
<span class="line-number">1168</span>
<span class="line-number">1169</span>      cmp bl, ID_BRIDGE
<span class="line-number">1170</span>      jz .set_interactive
<span class="line-number">1171</span>      cmp bl, ID_GOLD
<span class="line-number">1172</span>      jz .set_interactive
<span class="line-number">1173</span>      cmp bl, ID_ROCK
<span class="line-number">1174</span>      jz .set_interactive
<span class="line-number">1175</span>      cmp bl, ID_CHEST
<span class="line-number">1176</span>      jz .set_interactive
<span class="line-number">1177</span>      jmp .skip_interactive
<span class="line-number">1178</span>      .set_interactive:  
<span class="line-number">1179</span>        mov byte [di+_STATE_], STATE_INTERACTIVE
<span class="line-number">1180</span>      .skip_interactive:
<span class="line-number">1181</span>
<span class="line-number">1182</span>      add si, 0x02                  
<span class="line-number">1183</span>      add di, ENTITY_SIZE           
<span class="line-number">1184</span>      inc byte [_MAX_ENTITIES_]
<span class="line-number">1185</span>    loop .next_in_group
<span class="line-number">1186</span>  jmp .next_entity
<span class="line-number">1187</span>  .done:
<span class="line-number">1188</span>
<span class="line-number">1189</span>  mov word [_PLAYER_ENTITY_ID_], _ENTITIES_ 
<span class="line-number">1190</span>
<span class="line-number">1191</span>ret
<span class="line-number">1192</span>
</div>
                                                <div class="comment-column">












; Get first word (ID)
; Check for last entity marker




; Conv level id to game id


; Get amount in group
; mov to the next word (first entitie in group)
; Set loop

; Check if gold coin

; Count each gold as score target



; Save sprite id
; Get position
; Save position
; Save old position










; Save mirror (none)
; Save basic state
; Save basic state









; Set explore state to alive entities








; Random X mirror, for foliage














; Set interactive entities



; Move to the next entity in code
; Move to the next entity in memory





; Set player entity id to first entity



</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>CHECK BOUNDS</h3>
                                            <div class="sectionDescription">Expects: CX - Position YY/XX (CH: Y coordinate, CL: X coordinate)
Returns: AX - Zero if hit bound, 1 if no bounds at this location
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1196</span>
<span class="line-number">1197</span>check_bounds:
<span class="line-number">1198</span>  xor ax, ax             
<span class="line-number">1199</span>  cmp ch, 0x0f
<span class="line-number">1200</span>  ja .return
<span class="line-number">1201</span>  cmp cl, 0x1f
<span class="line-number">1202</span>  ja .return
<span class="line-number">1203</span>  inc ax                 
<span class="line-number">1204</span>.return:
<span class="line-number">1205</span>  test ax, 1             
<span class="line-number">1206</span>  ret
<span class="line-number">1207</span>
</div>
                                                <div class="comment-column">

; Assume bound hit (AX = 0)




; No bound hit (AX = 1)

; Set flags based on AX


</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>CHECK FRIEDS</h3>
                                            <div class="sectionDescription">Expects: CX - Position YY/XX
DL - skip check
Return: AX - Zero if hit entity, 1 if clear
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1212</span>
<span class="line-number">1213</span>check_friends:
<span class="line-number">1214</span>  push si
<span class="line-number">1215</span>  push cx
<span class="line-number">1216</span>  xor bx, bx
<span class="line-number">1217</span>  mov ax, cx
<span class="line-number">1218</span>
<span class="line-number">1219</span>  mov byte cl, [_MAX_ENTITIES_]
<span class="line-number">1220</span>  mov si, _ENTITIES_
<span class="line-number">1221</span>  .next_entity:
<span class="line-number">1222</span>    cmp byte [si+_STATE_], STATE_FOLLOW
<span class="line-number">1223</span>    jle .skip_this_entity
<span class="line-number">1224</span>    cmp word [si+_POS_], ax
<span class="line-number">1225</span>    jz .hit
<span class="line-number">1226</span>    .skip_this_entity:
<span class="line-number">1227</span>    add si, ENTITY_SIZE
<span class="line-number">1228</span>  loop .next_entity
<span class="line-number">1229</span>
<span class="line-number">1230</span>  jmp .done
<span class="line-number">1231</span>
<span class="line-number">1232</span>  .hit:
<span class="line-number">1233</span>  mov bx, 0x1
<span class="line-number">1234</span>  cmp bx, 0x1
<span class="line-number">1235</span>
<span class="line-number">1236</span>  .done:
<span class="line-number">1237</span>  pop cx
<span class="line-number">1238</span>  pop si
<span class="line-number">1239</span>
<span class="line-number">1240</span>ret
<span class="line-number">1241</span>
</div>
                                                <div class="comment-column">





























</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>CHECK WATER TILE</h3>
                                            <div class="sectionDescription">Expects: CX - Player position (CH: Y 0-15, CL: X 0-31)
Returns: AL - 0 if water (0xF), 1 otherwise
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1245</span>
<span class="line-number">1246</span>check_water_tile:
<span class="line-number">1247</span>  mov ax, cx      
<span class="line-number">1248</span>  shr ah, 1       
<span class="line-number">1249</span>  shr al, 1       
<span class="line-number">1250</span>  movzx bx, ah
<span class="line-number">1251</span>  shl bx, 4       
<span class="line-number">1252</span>  add bl, al      
<span class="line-number">1253</span>  add bx, LevelData
<span class="line-number">1254</span>  mov al, [bx]    
<span class="line-number">1255</span>  test al, 0x40   
<span class="line-number">1256</span>ret
<span class="line-number">1257</span>
<span class="line-number">1258</span>
</div>
                                                <div class="comment-column">

; Copy position to AX
; Y / 2
; X / 2 to convert to tile position

; Multily by 16 tiles wide
; Y / 2 * 16 + X / 2

; Read tile
; Check if movable (7th bit set)



</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>DRAWING LEVEL</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1260</span>draw_level:
<span class="line-number">1261</span>  push es
<span class="line-number">1262</span>  push _BG_BUFFER_MEMORY_
<span class="line-number">1263</span>  pop es                                  
<span class="line-number">1264</span>
<span class="line-number">1265</span>  mov si, LevelData
<span class="line-number">1266</span>  mov di, LEVEL_START_POSITION
<span class="line-number">1267</span>  xor cx, cx
<span class="line-number">1268</span>  .next_meta_tile:
<span class="line-number">1269</span>    push cx
<span class="line-number">1270</span>    push si
<span class="line-number">1271</span>
<span class="line-number">1272</span>    mov byte al, [si]     
<span class="line-number">1273</span>    mov bl, al            
<span class="line-number">1274</span>    shr bl, 0x4           
<span class="line-number">1275</span>    and bl, 0x3           
<span class="line-number">1276</span>
<span class="line-number">1277</span>    and ax, 0xf           
<span class="line-number">1278</span>    jnz .not_empty
<span class="line-number">1279</span>      add di, 16
<span class="line-number">1280</span>      jmp .skip_meta_tile
<span class="line-number">1281</span>    .not_empty:
<span class="line-number">1282</span>
<span class="line-number">1283</span>    mov si, MetaTiles
<span class="line-number">1284</span>    shl ax, 0x2           
<span class="line-number">1285</span>    add si, ax            
<span class="line-number">1286</span>
<span class="line-number">1287</span>    mov     dx, 0x0123       
<span class="line-number">1288</span>    .check_y:
<span class="line-number">1289</span>      test    bl, 2
<span class="line-number">1290</span>      jz      .check_x
<span class="line-number">1291</span>      xchg    dh, dl           
<span class="line-number">1292</span>    .check_x:
<span class="line-number">1293</span>      test    bl, 1
<span class="line-number">1294</span>      jz      .push_tiles
<span class="line-number">1295</span>      ror     dh, 4            
<span class="line-number">1296</span>      ror     dl, 4            
<span class="line-number">1297</span>
<span class="line-number">1298</span>    .push_tiles:
<span class="line-number">1299</span>        mov     cx, 4            
<span class="line-number">1300</span>    .next_tile_push:
<span class="line-number">1301</span>        push    dx               
<span class="line-number">1302</span>        ror     dx, 4            
<span class="line-number">1303</span>        loop    .next_tile_push
<span class="line-number">1304</span>
<span class="line-number">1305</span>    mov cx, 0x4           
<span class="line-number">1306</span>    .next_tile:
<span class="line-number">1307</span>      pop dx              
<span class="line-number">1308</span>      and dx, 0x7
<span class="line-number">1309</span>      push si
<span class="line-number">1310</span>      add si, dx
<span class="line-number">1311</span>      mov byte al, [si]   
<span class="line-number">1312</span>      pop si
<span class="line-number">1313</span>      mov bh, al
<span class="line-number">1314</span>      shr bh, 4            
<span class="line-number">1315</span>      and bh, 3            
<span class="line-number">1316</span>
<span class="line-number">1317</span>      xor bh, bl          
<span class="line-number">1318</span>      mov dl, bh          
<span class="line-number">1319</span>
<span class="line-number">1320</span>      and ax, 0xf         
<span class="line-number">1321</span>      dec ax              
<span class="line-number">1322</span>     imul ax, 18          
<span class="line-number">1323</span>
<span class="line-number">1324</span>      push si
<span class="line-number">1325</span>      mov si, TerrainTiles
<span class="line-number">1326</span>      add si, ax
<span class="line-number">1327</span>      call draw_sprite
<span class="line-number">1328</span>      pop si
<span class="line-number">1329</span>
<span class="line-number">1330</span>      add di, 8
<span class="line-number">1331</span>
<span class="line-number">1332</span>      cmp cx, 0x3
<span class="line-number">1333</span>      jnz .skip_set_new_line
<span class="line-number">1334</span>        add di, 320*8-16  
<span class="line-number">1335</span>      .skip_set_new_line:
<span class="line-number">1336</span>
<span class="line-number">1337</span>    loop .next_tile
<span class="line-number">1338</span>    sub di, 320*8
<span class="line-number">1339</span>    .skip_meta_tile:
<span class="line-number">1340</span>
<span class="line-number">1341</span>    pop si
<span class="line-number">1342</span>    inc si
<span class="line-number">1343</span>    pop cx
<span class="line-number">1344</span>    inc cx
<span class="line-number">1345</span>    test cx, 0xf
<span class="line-number">1346</span>    jnz .no_new_line
<span class="line-number">1347</span>      add di, 320*16-(16*16)  
<span class="line-number">1348</span>    .no_new_line:
<span class="line-number">1349</span>
<span class="line-number">1350</span>    cmp cx, 0x80           
<span class="line-number">1351</span>  jl .next_meta_tile
<span class="line-number">1352</span>  
<span class="line-number">1353</span>  pop es
<span class="line-number">1354</span>ret
<span class="line-number">1355</span>
<span class="line-number">1356</span>
</div>
                                                <div class="comment-column">


; as target








; Read level cell
; Make a copy
; Remove first nible
; Read XY mirroring - BL

; Read first nibble - AX






; ID*4 Move to position; 4 bytes per tile
; Meta-tile address

; Default order: 0, 1, 2, 3



; Swap top and bottom rows (Order: 2, 3, 0, 1)



; Swap nibbles in dh (tiles in positions 0 and 1)
; Swap nibbles in dl (tiles in positions 2 and 3)


; 4 tiles to push

; Push the tile ID
; Rotate dx to get the next tile ID in place


; 2x2 tiles

; Get tile order



; Read meta-tile with order


; Extract the upper 4 bits
; Mask to get the mirror flags (both X and Y)

; invert original tile mirror by meta-tile mirror
; set final mirror for tile

; First nibble
; We do not have tile 0, shifting values
; Move to position











; Word wrap












; Move to the next display line


; 128 = 16*8






</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>DRAWING SHIP</h3>
                                            <div class="sectionDescription">in: bx - wiosla
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1359</span>
<span class="line-number">1360</span>draw_ship:
<span class="line-number">1361</span>  xor dx, dx
<span class="line-number">1362</span>
<span class="line-number">1363</span>  mov ax, [_GAME_TICK_]
<span class="line-number">1364</span>  and ax, 0xf
<span class="line-number">1365</span>  cmp ax, 0x6
<span class="line-number">1366</span>  jl .skip_wave
<span class="line-number">1367</span>    sub di, 320
<span class="line-number">1368</span>  .skip_wave:
<span class="line-number">1369</span>  mov si, ShipBackBrush
<span class="line-number">1370</span>  call draw_sprite
<span class="line-number">1371</span>  add di, 8 + 320*4
<span class="line-number">1372</span>  mov si, ShipMiddleBrush
<span class="line-number">1373</span>  call draw_sprite
<span class="line-number">1374</span>  add di, 8
<span class="line-number">1375</span>  mov si, ShipMiddleBrush
<span class="line-number">1376</span>  call draw_sprite
<span class="line-number">1377</span>  add di, 8
<span class="line-number">1378</span>  mov si, ShipFrontBrush
<span class="line-number">1379</span>  call draw_sprite
<span class="line-number">1380</span>
<span class="line-number">1381</span>  mov si, ShipSailBrush
<span class="line-number">1382</span>  sub di, 12 + 320*5
<span class="line-number">1383</span>  call draw_sprite
<span class="line-number">1384</span>  add di, 320*2 - 4
<span class="line-number">1385</span>  call draw_sprite
<span class="line-number">1386</span>  sub di, 320*7 - 3
<span class="line-number">1387</span>  call draw_sprite
<span class="line-number">1388</span>  add di, 320*2 - 4
<span class="line-number">1389</span>  call draw_sprite
<span class="line-number">1390</span>  sub di, 320*6 - 1
<span class="line-number">1391</span>  call draw_sprite
<span class="line-number">1392</span>
<span class="line-number">1393</span>  add di, 320*10 + 10
<span class="line-number">1394</span>  call draw_sprite
<span class="line-number">1395</span>  sub di, 320*4 + 2
<span class="line-number">1396</span>  call draw_sprite
<span class="line-number">1397</span>
<span class="line-number">1398</span>  cmp bx, 0x1
<span class="line-number">1399</span>  jnz .skip_wiosla
<span class="line-number">1400</span>  xor dx, dx
<span class="line-number">1401</span>  mov ax, [_GAME_TICK_]
<span class="line-number">1402</span>  shr ax, 3
<span class="line-number">1403</span>  and ax, 0x1
<span class="line-number">1404</span>  add dl, al
<span class="line-number">1405</span>  sub di, ax
<span class="line-number">1406</span>  sub di, ax
<span class="line-number">1407</span>  sub di, ax
<span class="line-number">1408</span>  mov si, WioslaBrush
<span class="line-number">1409</span>  add di, 320*15-7
<span class="line-number">1410</span>  call draw_sprite
<span class="line-number">1411</span>  add di, 8
<span class="line-number">1412</span>  call draw_sprite
<span class="line-number">1413</span>  .skip_wiosla:
<span class="line-number">1414</span>ret
<span class="line-number">1415</span>
</div>
                                                <div class="comment-column">
























































</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>DRAW VECTOR</h3>
                                            <div class="sectionDescription">shadow
double line
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1417</span>draw_vector:   
<span class="line-number">1418</span>  pusha 
<span class="line-number">1419</span>  .read_group:
<span class="line-number">1420</span>    xor cx, cx
<span class="line-number">1421</span>    mov cl, [si]
<span class="line-number">1422</span>    cmp cl, 0x0
<span class="line-number">1423</span>    jz .done
<span class="line-number">1424</span>
<span class="line-number">1425</span>    inc si
<span class="line-number">1426</span>
<span class="line-number">1427</span>    .read_line:
<span class="line-number">1428</span>    push cx
<span class="line-number">1429</span>
<span class="line-number">1430</span>    xor ax, ax
<span class="line-number">1431</span>    mov al, [si]
<span class="line-number">1432</span>    add ax, bp
<span class="line-number">1433</span>
<span class="line-number">1434</span>    xor bx, bx
<span class="line-number">1435</span>    mov bl, [si+2]
<span class="line-number">1436</span>    add bx, bp
<span class="line-number">1437</span>    mov dl, [si+1]
<span class="line-number">1438</span>    mov dh, [si+3]    
<span class="line-number">1439</span>    mov cx, [_VECTOR_COLOR_]  
<span class="line-number">1440</span>    mov ch, cl
<span class="line-number">1441</span>
<span class="line-number">1443</span>    call draw_line
<span class="line-number">1444</span>    
<span class="line-number">1445</span>    mov cx, [_VECTOR_COLOR_]  
<span class="line-number">1446</span>    mov cl, ch
<span class="line-number">1447</span>    dec ax
<span class="line-number">1448</span>    dec bx
<span class="line-number">1449</span>    dec dh
<span class="line-number">1450</span>    dec dl    
<span class="line-number">1451</span>    call draw_line
<span class="line-number">1452</span>
<span class="line-number">1454</span>    inc cl
<span class="line-number">1455</span>    inc ch
<span class="line-number">1456</span>    dec ax
<span class="line-number">1457</span>    dec bx 
<span class="line-number">1458</span>    call draw_line
<span class="line-number">1459</span>
<span class="line-number">1460</span>    add si, 2
<span class="line-number">1461</span>    pop cx
<span class="line-number">1462</span>    loop .read_line
<span class="line-number">1463</span>    add si, 2
<span class="line-number">1464</span>    jmp .read_group
<span class="line-number">1465</span>  .done:
<span class="line-number">1466</span>  popa
<span class="line-number">1467</span>  ret
<span class="line-number">1468</span>
</div>
                                                <div class="comment-column">





















; shadow color




; line color






















</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>DRAWING LINE</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"></div>
                                                <div class="comment-column"></div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>axx0</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"></div>
                                                <div class="comment-column"></div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>bxx1</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"></div>
                                                <div class="comment-column"></div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>dly0,</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"></div>
                                                <div class="comment-column"></div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>dhy1,</h3>
                                            <div class="sectionDescription"></div>
                                            <div class="asmView">
                                                <div class="code-column"></div>
                                                <div class="comment-column"></div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>clcol</h3>
                                            <div class="sectionDescription">Spektre @ https://stackoverflow.com/questions/71390507/line-drawing-algorithm-in-assembly#71391899
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1476</span>draw_line:
<span class="line-number">1477</span>  pusha       
<span class="line-number">1478</span>    push    ax
<span class="line-number">1479</span>    mov si,bx
<span class="line-number">1480</span>    sub si,ax
<span class="line-number">1481</span>    sub ah,ah
<span class="line-number">1482</span>    mov al,dl
<span class="line-number">1483</span>    mov bx,ax
<span class="line-number">1484</span>    mov al,dh
<span class="line-number">1485</span>    sub ax,bx
<span class="line-number">1486</span>    mov di,ax
<span class="line-number">1487</span>    mov ax,320
<span class="line-number">1488</span>    sub dh,dh
<span class="line-number">1489</span>    mul dx
<span class="line-number">1490</span>    pop bx
<span class="line-number">1491</span>    add ax,bx
<span class="line-number">1492</span>    mov bp,ax
<span class="line-number">1493</span>    mov ax,1
<span class="line-number">1494</span>    mov bx,320
<span class="line-number">1495</span>    cmp si,32768
<span class="line-number">1496</span>    jb  .r0
<span class="line-number">1497</span>    neg si
<span class="line-number">1498</span>    neg ax
<span class="line-number">1499</span> .r0:    cmp di,32768
<span class="line-number">1500</span>    jb  .r1
<span class="line-number">1501</span>    neg di
<span class="line-number">1502</span>    neg bx
<span class="line-number">1503</span> .r1:    cmp si,di
<span class="line-number">1504</span>    ja  .r2
<span class="line-number">1505</span>    xchg    ax,bx
<span class="line-number">1506</span>    xchg    si,di
<span class="line-number">1507</span> .r2:    mov [.ct],si
<span class="line-number">1508</span> .l0:    mov word [es:bp], cx
<span class="line-number">1509</span>    add bp,ax
<span class="line-number">1510</span>    sub dx,di
<span class="line-number">1511</span>    jnc .r3
<span class="line-number">1512</span>    add dx,si
<span class="line-number">1513</span>    add bp,bx
<span class="line-number">1514</span> .r3:    dec word [.ct]
<span class="line-number">1515</span>    jnz .l0
<span class="line-number">1516</span>    popa
<span class="line-number">1517</span>    ret
<span class="line-number">1518</span> .ct:    dw  0
<span class="line-number">1519</span>
<span class="line-number">1520</span>
</div>
                                                <div class="comment-column">












































</div>
                                            </div>
                                        </div>
                                    
                                        <div class="asmSection">
                                            <h3>DRAW SPRITE PROCEDURE</h3>
                                            <div class="sectionDescription">Expects:
DI - positon (linear)
DL - settings: 0 normal, 1 mirrored x, 2 mirrored y, 3 mirrored x&amp;y
DH - frame number
Return: -
</div>
                                            <div class="asmView">
                                                <div class="code-column"><span class="line-number">1527</span>
<span class="line-number">1528</span>draw_sprite:
<span class="line-number">1529</span>  pusha
<span class="line-number">1530</span>
<span class="line-number">1531</span>  xor cx, cx
<span class="line-number">1532</span>  mov byte cl, [si]       
<span class="line-number">1533</span>
<span class="line-number">1534</span>  inc si
<span class="line-number">1535</span>
<span class="line-number">1536</span>  xor ax, ax
<span class="line-number">1537</span>  mov byte al, [si]       
<span class="line-number">1538</span>  inc si
<span class="line-number">1539</span>
<span class="line-number">1540</span>  shl ax, 0x2              
<span class="line-number">1541</span>  mov bp, ax
<span class="line-number">1542</span>  add bp, PaletteSets
<span class="line-number">1543</span>
<span class="line-number">1544</span>  movzx ax, dh  
<span class="line-number">1545</span> imul ax, cx    
<span class="line-number">1546</span>  shl ax, 0x1   
<span class="line-number">1547</span>  add si, ax    
<span class="line-number">1548</span>
<span class="line-number">1549</span>  test dl, 0x1              
<span class="line-number">1550</span>  jz .no_x_mirror
<span class="line-number">1551</span>    add di, 0x7             
<span class="line-number">1552</span>  .no_x_mirror:
<span class="line-number">1553</span>
<span class="line-number">1554</span>  test dl, 0x2              
<span class="line-number">1555</span>  jz .no_y_mirror
<span class="line-number">1556</span>    add si, cx
<span class="line-number">1557</span>    add si, cx              
<span class="line-number">1558</span>    sub si, 0x2             
<span class="line-number">1559</span>  .no_y_mirror:
<span class="line-number">1560</span>
<span class="line-number">1561</span>  .plot_line:
<span class="line-number">1562</span>      push cx           
<span class="line-number">1563</span>      mov ax, [si]      
<span class="line-number">1564</span>      xor bx, bx
<span class="line-number">1565</span>      mov cl, 0x08      
<span class="line-number">1566</span>      push si
<span class="line-number">1567</span>      .draw_pixel:
<span class="line-number">1568</span>          push cx
<span class="line-number">1569</span>
<span class="line-number">1570</span>          rol ax, 2
<span class="line-number">1571</span>          mov bx, ax
<span class="line-number">1572</span>          and bx, 0x3
<span class="line-number">1573</span>
<span class="line-number">1574</span>          mov si, bp      
<span class="line-number">1575</span>          add si, bx      
<span class="line-number">1576</span>          mov byte bl, [si] 
<span class="line-number">1577</span>
<span class="line-number">1578</span>          cmp bl, 0x0        
<span class="line-number">1579</span>          jz .skip_pixel
<span class="line-number">1580</span>            mov byte [es:di], bl  
<span class="line-number">1581</span>          .skip_pixel:     
<span class="line-number">1582</span>
<span class="line-number">1583</span>          inc di           
<span class="line-number">1584</span>
<span class="line-number">1585</span>          mov bl, dl
<span class="line-number">1586</span>          and bl, 0x1
<span class="line-number">1587</span>          jz .no_x_mirror2          
<span class="line-number">1588</span>            dec di           
<span class="line-number">1589</span>            dec di           
<span class="line-number">1590</span>          .no_x_mirror2:
<span class="line-number">1591</span>
<span class="line-number">1592</span>          pop cx
<span class="line-number">1593</span>          loop .draw_pixel
<span class="line-number">1594</span>
<span class="line-number">1595</span>      pop si
<span class="line-number">1596</span>      add si, 0x2               
<span class="line-number">1597</span>
<span class="line-number">1598</span>      mov bl, dl
<span class="line-number">1599</span>      and bl, 0x2
<span class="line-number">1600</span>      jz .no_y_mirror2
<span class="line-number">1601</span>        sub si, 0x4
<span class="line-number">1602</span>      .no_y_mirror2:
<span class="line-number">1603</span>
<span class="line-number">1604</span>      add di, 312          
<span class="line-number">1605</span>
<span class="line-number">1606</span>      mov bl, dl
<span class="line-number">1607</span>      and bl, 0x1
<span class="line-number">1608</span>      jz .no_x_mirror3
<span class="line-number">1609</span>        add di, 0x10           
<span class="line-number">1610</span>      .no_x_mirror3:
<span class="line-number">1611</span>
<span class="line-number">1612</span>  pop cx                   
<span class="line-number">1613</span>  loop .plot_line
<span class="line-number">1614</span>  popa
<span class="line-number">1615</span>ret
<span class="line-number">1616</span>
</div>
                                                <div class="comment-column">




; lines




; Palette


; each set is 4x 1 byte



; Get frame
; muliply by lines
; *2 bytes per line
; Mobe to the frame memory position

; Check x mirror

; Move point to the last right pixel


; Check


; Move to the last position
; Back one word



; Save lines couter
; Get sprite line

; 8 pixels in line








; Palette Set
; Palette color
; Get color from the palette

; transparency

; Write pixel color
; Or skip this pixel - alpha color

; Move destination to next pixel (+1)



; Jump if not
; Remove previous shift (now it's 0)
; Move destination 1px left (-1)






; Move to the next sprite line data







; Move to next line in destination




; If mirrored adjust next line position


; Restore line counter




</div>
                                            </div>
                                        </div>
                                    
                            <div class="asmSection">
                                <h3>THE END</h3>
                                <div class="sectionDescription">Thanks for reading the source code!
Visit http://smol.p1x.in for more.
</div>
                                <div class="asmView">
                                    <div class="code-column"><span class="line-number">1620</span>
<span class="line-number">1621</span>
<span class="line-number">1622</span>Logo:
<span class="line-number">1623</span>db "P1X"    
<span class="line-number">1624</span>
</div>
                                    <div class="comment-column">


; Use HEX viewer to see P1X at the end of binary

</div>
                                </div>
                            </div>
                        </div>
    </body>
    </html>